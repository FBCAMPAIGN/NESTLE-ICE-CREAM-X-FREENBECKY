<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ice Cream Map ‚Äî Fixed icons</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0}
    header{height:50px;line-height:50px;text-align:center;background:#f8f9fa;border-bottom:1px solid #ddd;font-weight:700}
    #controls{padding:8px;text-align:center;background:#fff;z-index:1000}
    #map{height:calc(100vh - 90px);width:100%}
    .popup-content{font-size:14px}
    .legend{background:#fff;padding:6px 10px;border:1px solid #ccc;border-radius:6px}
    .legend .dot{display:inline-block;width:12px;height:12px;margin-right:6px;border-radius:50%;vertical-align:middle}
  </style>
</head>
<body>
  <header>üç¶ Nestle Ice Cream X FreenBecky</header>
  <div id="controls">
    <label><input type="checkbox" id="filterChocolate" checked> üç´ Chocolate</label>
    <label style="margin-left:12px"><input type="checkbox" id="filterStrawberry" checked> üçì Strawberry</label>
  </div>

  <div id="map"></div>

  <!-- Leaflet & PapaParse -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // ----------------- CONFIG -----------------
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIfTQc169pc5cSpkMIj0c9k2ZzNHZkptMZS68ebzx0i22WOft68xqypJeDJhU70r2yRwTxzIBjQOJW/pub?gid=0&single=true&output=csv";
  // colors (hex)
  const COLORS = {
    brown: "#8B4513",   // chocolate-only
    red:   "#e74c3c",   // strawberry-only
    green: "#27ae60",   // both
    grey:  "#95a5a6"    // not updated
  };
  // ------------------------------------------

  const map = L.map('map').setView([13.736717, 100.523186], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Create svg marker (pin-like) as data URI (no external image)
  function createSvgIcon(colorHex) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="44" viewBox="0 0 30 44">
        <defs>
          <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity="0.3"/>
          </filter>
        </defs>
        <path filter="url(#s)" d="M15 0C9 0 4 5 4 10c0 7.5 11 22 11 22s11-14.5 11-22c0-5-5-10-11-10z" fill="${colorHex}" stroke="#333" stroke-width="1"/>
        <circle cx="15" cy="10" r="4" fill="rgba(255,255,255,0.9)"/>
      </svg>`;
    const uri = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg.trim());
    return new L.Icon({
      iconUrl: uri,
      iconSize: [30, 44],
      iconAnchor: [15, 44],
      popupAnchor: [0, -36],
      shadowUrl: null
    });
  }

  const ICONS = {
    brown: createSvgIcon(COLORS.brown),
    red: createSvgIcon(COLORS.red),
    green: createSvgIcon(COLORS.green),
    grey: createSvgIcon(COLORS.grey)
  };

  // helper: safe html escape
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // normalize row keys to allow flexible headers
  function normalizeRow(row){
    const norm = {};
    for(const k in row){
      const nk = k.trim().toLowerCase().replace(/\s+/g,'');
      norm[nk] = row[k];
    }
    // map known keys
    return {
      store: norm.store || norm.name || norm.tencuahang || norm['store'] || '',
      lat: parseFloat((norm.lat || norm.latitude || norm.b || '').toString().replace(/,/g,'.')),
      lng: parseFloat((norm.lng || norm.lon || norm.longitude || norm.c || '').toString().replace(/,/g,'.')),
      chocolate: String(norm.chocolate || norm.choco || '').trim().toLowerCase() === 'true',
      strawberry: String(norm.strawberry || norm.straw || '').trim().toLowerCase() === 'true',
      lastUpdate: (norm.lastupdate || norm.lastupdate || norm.updated || norm['lastupdate'] || '').toString().trim()
    };
  }

  let allMarkers = []; // store marker objects

  // build popup html using emojis (no external images)
  function buildPopup(d){
    if(!d.hasUpdate){
      return `<div class="popup-content"><b>${escapeHtml(d.store)}</b><br><b>Last update:</b> Not updated yet</div>`;
    }
    const choc = d.chocolate ? "<span style='color:green'>‚úÖ</span>" : "<span style='color:red'>‚ùå</span>";
    const straw = d.strawberry ? "<span style='color:green'>‚úÖ</span>" : "<span style='color:red'>‚ùå</span>";
    return `<div class="popup-content"><b>${escapeHtml(d.store)}</b><br><b>Last update:</b> ${escapeHtml(d.lastUpdate)}<br>üç´ ${choc}<br>üçì ${straw}</div>`;
  }

  // load CSV with PapaParse
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(res){
      const data = res.data;
      const markersForBounds = [];
      data.forEach(rawRow => {
        const r = normalizeRow(rawRow);
        // skip rows without coords
        if (Number.isNaN(r.lat) || Number.isNaN(r.lng)) return;

        const hasUpdate = r.lastUpdate && r.lastUpdate !== '' && r.lastUpdate.toLowerCase() !== 'false';
        const markerData = {
          store: r.store || 'No name',
          lat: r.lat,
          lng: r.lng,
          chocolate: !!r.chocolate,
          strawberry: !!r.strawberry,
          hasUpdate,
          lastUpdate: r.lastUpdate || ''
        };

        // choose icon
        let icon;
        if (!hasUpdate) {
          icon = ICONS.grey;
        } else if (markerData.chocolate && markerData.strawberry) {
          icon = ICONS.green;
        } else if (markerData.chocolate) {
          icon = ICONS.brown;
        } else if (markerData.strawberry) {
          icon = ICONS.red;
        } else {
          icon = ICONS.grey;
        }

        const marker = L.marker([markerData.lat, markerData.lng], { icon })
          .bindPopup(buildPopup(markerData));

        // attach data for filtering
        marker.storeData = markerData;
        marker.addTo(map);
        allMarkers.push(marker);
        markersForBounds.push(marker);
      });

      // fit bounds if any
      if(markersForBounds.length){
        const group = L.featureGroup(markersForBounds);
        map.fitBounds(group.getBounds().pad(0.05));
      }

      // apply initial filter logic (so gray pins always visible)
      applyFilters();
    },
    error: function(err){
      console.error('CSV load error', err);
      alert('Error loading CSV ‚Äî check console.');
    }
  });

  // filter logic: gray (not updated) always visible
  function applyFilters(){
    const showChocolate = document.getElementById('filterChocolate').checked;
    const showStrawberry = document.getElementById('filterStrawberry').checked;

    allMarkers.forEach(marker => {
      const d = marker.storeData;
      if(!d.hasUpdate){
        if(!map.hasLayer(marker)) map.addLayer(marker); // always show gray
        return;
      }
      const visible = (d.chocolate && showChocolate) || (d.strawberry && showStrawberry);
      if(visible){
        if(!map.hasLayer(marker)) map.addLayer(marker);
      } else {
        if(map.hasLayer(marker)) map.removeLayer(marker);
      }
    });
  }

  document.getElementById('filterChocolate').addEventListener('change', applyFilters);
  document.getElementById('filterStrawberry').addEventListener('change', applyFilters);

  // add legend control
  const legend = L.control({position:'bottomright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">Legend</div>
      <div><span class="dot" style="background:${COLORS.brown}"></span> Chocolate only</div>
      <div><span class="dot" style="background:${COLORS.red}"></span> Strawberry only</div>
      <div><span class="dot" style="background:${COLORS.green}"></span> Both flavors</div>
      <div><span class="dot" style="background:${COLORS.grey}"></span> Not updated</div>
    `;
    return div;
  };
  legend.addTo(map);

  </script>
</body>
</html>
