<script>
  // Tạo bản đồ
  const map = L.map('map').setView([13.736, 100.533], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 19,
  }).addTo(map);

  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIfTQc169pc5cSpkMIj0c9k2ZzNHZkptMZS68ebzx0i22WOft68xqypJeDJhU70r2yRwTxzIBjQOJW/pub?gid=0&single=true&output=csv";

  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    complete: function(results) {
      results.data.forEach(row => {
        if (!row.Lat || !row.Lng) return;

        // Lấy cột Last Update (bất kể viết thế nào)
        let lastUpdate = "";
        for (const key in row) {
          if (key.toLowerCase().includes("last update")) {
            lastUpdate = row[key] ? row[key].trim() : "";
          }
        }
        if (!lastUpdate) lastUpdate = "Chưa có cập nhật";

        let status = row.Status ? row.Status.trim() : "Chưa update";

        let color;
        if (status.toLowerCase().includes("còn")) {
          color = "green";
        } else if (status.toLowerCase().includes("hết")) {
          color = "red";
        } else {
          color = "gray"; // chưa update
        }

        const marker = L.circleMarker(
          [parseFloat(row.Lat), parseFloat(row.Lng)],
          {
            color: color,
            radius: 8,
            fillOpacity: 0.8
          }
        ).addTo(map);

        marker.bindPopup(`
          <b>${row.Name || "Không rõ"}</b><br>
          Vị: ${row.Flavor || "Không rõ"}<br>
          Tình trạng: ${status}<br>
          Cập nhật: ${lastUpdate}
        `);
      });
    }
  });
</script>
